{% extends 'base.html' %}
{% load static %}

{% block title %}Create User - PIMS - Bangladesh Parliament Secretariat{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item"><a href="{% url 'users:list' %}">Users</a></li>
    <li class="breadcrumb-item active">Create User</li>
{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<style>
/* User Create Template - Bangladesh Parliament Secretariat PIMS */
/* Location: Dhaka, Bangladesh - Flat Design with High Contrast */
/* PRP Integration Support - Following Template Design Pattern Rule */

:root {
    --primary-teal: #14b8a6;
    --primary-teal-hover: #0f9488;
    --primary-orange: #f97316;
    --primary-red: #ef4444;
    --text-primary: #1e293b;
    --text-secondary: #64748b;
    --bg-primary: #ffffff;
    --bg-secondary: #f8fafc;
    --border-light: #e2e8f0;
    --shadow-card: 0 4px 12px rgba(0, 0, 0, 0.08);
    --shadow-hover: 0 8px 24px rgba(0, 0, 0, 0.12);
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --prp-sync-bg: #ecfdf5;
    --prp-readonly-bg: #f8f9fa;
    --prp-indicator: #14b8a6;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background-color: var(--bg-secondary);
}

/* Main Container */
.create-container {
    background: linear-gradient(135deg, var(--bg-secondary) 0%, #e2e8f0 100%);
    min-height: 100vh;
    padding: 2rem 0;
}

/* Page Header */
.page-header {
    background: var(--bg-primary);
    border: 1px solid var(--border-light);
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-card);
    position: relative;
    overflow: hidden;
}

.page-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(135deg, var(--primary-teal) 0%, var(--primary-orange) 100%);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-wrap: wrap;
    gap: 1.5rem;
}

.page-title-section h1 {
    color: var(--text-primary);
    font-weight: 700;
    margin-bottom: 0.5rem;
    font-size: 2rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.page-title-section h1 i {
    color: var(--primary-teal);
    background: rgba(20, 184, 166, 0.1);
    padding: 0.75rem;
    border-radius: 12px;
    font-size: 1.5rem;
}

.page-title-section p {
    color: var(--text-secondary);
    margin-bottom: 0;
    font-size: 1.125rem;
}

.header-actions {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    align-items: center;
}

/* PRP Sync Options Section */
.prp-sync-section {
    background: var(--prp-sync-bg);
    border: 2px solid var(--primary-teal);
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
}

.prp-sync-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(135deg, var(--primary-teal) 0%, var(--success) 100%);
}

.prp-sync-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.prp-sync-title {
    color: var(--text-primary);
    font-weight: 700;
    font-size: 1.25rem;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.prp-sync-title i {
    color: var(--primary-teal);
    background: rgba(20, 184, 166, 0.2);
    padding: 0.5rem;
    border-radius: 8px;
}

.prp-sync-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.prp-option-card {
    background: var(--bg-primary);
    border: 2px solid var(--border-light);
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
}

.prp-option-card:hover {
    border-color: var(--primary-teal);
    box-shadow: var(--shadow-hover);
    transform: translateY(-2px);
}

.prp-option-card.active {
    border-color: var(--primary-teal);
    background: rgba(20, 184, 166, 0.05);
}

.prp-option-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.prp-option-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    color: white;
}

.sync-from-prp .prp-option-icon {
    background: linear-gradient(135deg, var(--primary-teal), var(--success));
}

.manual-create .prp-option-icon {
    background: linear-gradient(135deg, var(--primary-orange), var(--warning));
}

.prp-option-title {
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
    font-size: 1.125rem;
}

.prp-option-description {
    color: var(--text-secondary);
    margin: 0;
    font-size: 0.875rem;
    line-height: 1.5;
}

/* PRP Employee Lookup */
.prp-lookup-section {
    background: var(--bg-primary);
    border-radius: 12px;
    padding: 1.5rem;
    margin-top: 1.5rem;
    border: 1px solid var(--border-light);
    display: none;
}

.prp-lookup-section.active {
    display: block;
}

.lookup-form {
    display: flex;
    gap: 1rem;
    align-items: end;
    flex-wrap: wrap;
}

.lookup-group {
    flex: 1;
    min-width: 200px;
}

.lookup-label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.875rem;
}

.lookup-input {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid var(--border-light);
    border-radius: 8px;
    font-size: 0.875rem;
    transition: all 0.3s ease;
    background: var(--bg-primary);
}

.lookup-input:focus {
    outline: none;
    border-color: var(--primary-teal);
    box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
}

.btn-prp {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.btn-sync {
    background: linear-gradient(135deg, var(--primary-teal), var(--primary-teal-hover));
    color: white;
}

.btn-sync:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-hover);
    color: white;
}

.btn-outline-teal {
    background: var(--bg-primary);
    color: var(--primary-teal);
    border: 2px solid var(--primary-teal);
}

.btn-outline-teal:hover {
    background: var(--primary-teal);
    color: white;
    transform: translateY(-1px);
}

/* PRP User Preview */
.prp-user-preview {
    background: var(--bg-primary);
    border: 2px solid var(--success);
    border-radius: 12px;
    padding: 1.5rem;
    margin-top: 1.5rem;
    display: none;
}

.prp-user-preview.active {
    display: block;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.preview-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-light);
}

.preview-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-teal), var(--success));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    font-weight: bold;
}

.preview-info h4 {
    color: var(--text-primary);
    font-weight: 600;
    margin: 0 0 0.25rem 0;
    font-size: 1.25rem;
}

.preview-info p {
    color: var(--text-secondary);
    margin: 0;
    font-size: 0.875rem;
}

.preview-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

.preview-field {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.preview-label {
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.preview-value {
    color: var(--text-primary);
    font-size: 0.875rem;
    font-weight: 500;
}

/* Regular Form Section */
.form-container {
    background: var(--bg-primary);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: var(--shadow-card);
    border: 1px solid var(--border-light);
    margin-bottom: 2rem;
}

.form-header {
    background: linear-gradient(135deg, var(--primary-orange) 0%, #ea580c 100%);
    color: white;
    padding: 1.5rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.form-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.form-body {
    padding: 2rem;
}

/* Form Sections */
.form-section {
    margin-bottom: 2rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid var(--border-light);
}

.form-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.form-section-title {
    color: var(--text-primary);
    font-weight: 600;
    font-size: 1.125rem;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--border-light);
}

.form-section-title i {
    color: var(--primary-teal);
    background: rgba(20, 184, 166, 0.1);
    padding: 0.5rem;
    border-radius: 8px;
    font-size: 1rem;
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.form-label {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.form-label.required::after {
    content: '*';
    color: var(--primary-red);
    font-weight: bold;
}

.form-control {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid var(--border-light);
    border-radius: 8px;
    font-size: 0.875rem;
    transition: all 0.3s ease;
    background: var(--bg-primary);
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-teal);
    box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
}

.form-control.is-invalid {
    border-color: var(--primary-red);
}

/* PRP Read-only styling */
.form-control[readonly] {
    background: var(--prp-readonly-bg);
    border-color: var(--prp-indicator);
    color: var(--text-secondary);
    cursor: not-allowed;
}

.form-control[readonly]:focus {
    border-color: var(--prp-indicator);
    box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
}

.form-text {
    font-size: 0.75rem;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.invalid-feedback {
    display: block;
    width: 100%;
    margin-top: 0.25rem;
    font-size: 0.75rem;
    color: var(--primary-red);
}

/* Checkbox styling */
.form-check {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem;
    background: var(--bg-secondary);
    border-radius: 8px;
    border: 1px solid var(--border-light);
}

.form-check-input[type="checkbox"] {
    width: 1.25rem;
    height: 1.25rem;
    margin: 0;
    border: 2px solid var(--border-light);
    border-radius: 4px;
}

.form-check-input[type="checkbox"]:checked {
    background-color: var(--primary-teal);
    border-color: var(--primary-teal);
}

.form-check-label {
    font-weight: 500;
    color: var(--text-primary);
    font-size: 0.875rem;
    margin: 0;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Form Footer */
.form-footer {
    background: var(--bg-secondary);
    padding: 1.5rem 2rem;
    border-top: 1px solid var(--border-light);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.form-actions {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.btn-modern {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary-teal), var(--primary-teal-hover));
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-hover);
    color: white;
    text-decoration: none;
}

.btn-secondary {
    background: var(--bg-primary);
    color: var(--text-secondary);
    border: 2px solid var(--border-light);
}

.btn-secondary:hover {
    background: var(--bg-secondary);
    border-color: var(--text-secondary);
    color: var(--text-primary);
    text-decoration: none;
}

/* Status Indicators */
.sync-status {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.sync-status.synced {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success);
    border: 1px solid rgba(16, 185, 129, 0.2);
}

.sync-status.pending {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning);
    border: 1px solid rgba(245, 158, 11, 0.2);
}

.sync-status.error {
    background: rgba(239, 68, 68, 0.1);
    color: var(--danger);
    border: 1px solid rgba(239, 68, 68, 0.2);
}

/* PRP Indicator Badge */
.prp-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    background: rgba(20, 184, 166, 0.1);
    color: var(--primary-teal);
    border-radius: 12px;
    font-size: 0.625rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

/* Alert Styles */
.alert {
    padding: 1rem 1.5rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    border: none;
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.alert-info {
    background: rgba(59, 130, 246, 0.1);
    color: #1e40af;
    border: 1px solid rgba(59, 130, 246, 0.2);
}

.alert-warning {
    background: rgba(245, 158, 11, 0.1);
    color: #92400e;
    border: 1px solid rgba(245, 158, 11, 0.2);
}

.alert-success {
    background: rgba(16, 185, 129, 0.1);
    color: #065f46;
    border: 1px solid rgba(16, 185, 129, 0.2);
}

.alert-danger {
    background: rgba(239, 68, 68, 0.1);
    color: #991b1b;
    border: 1px solid rgba(239, 68, 68, 0.2);
}

/* Responsive Design */
@media (max-width: 1200px) {
    .prp-sync-options {
        grid-template-columns: 1fr;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .lookup-form {
        flex-direction: column;
        align-items: stretch;
    }
}

@media (max-width: 768px) {
    .create-container {
        padding: 1rem 0;
    }
    
    .page-header,
    .form-body {
        padding: 1.5rem;
    }
    
    .header-content {
        flex-direction: column;
        align-items: stretch;
    }
    
    .header-actions {
        justify-content: flex-start;
    }
    
    .form-footer {
        flex-direction: column;
        align-items: stretch;
    }
    
    .form-actions {
        justify-content: center;
    }
}

@media (max-width: 576px) {
    .page-header,
    .prp-sync-section,
    .form-body {
        padding: 1rem;
    }
    
    .prp-option-card {
        padding: 1rem;
    }
    
    .preview-details {
        grid-template-columns: 1fr;
    }
    
    .btn-modern {
        width: 100%;
        justify-content: center;
    }
}

/* High contrast mode */
@media (prefers-contrast: high) {
    .form-control,
    .lookup-input {
        border-width: 3px;
    }
    
    .btn-primary,
    .btn-sync {
        border: 3px solid var(--primary-teal);
    }
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce) {
    * {
        transition: none !important;
        animation: none !important;
    }
}

/* Focus indicators for accessibility */
.btn-modern:focus,
.form-control:focus,
.prp-option-card:focus {
    outline: 3px solid rgba(20, 184, 166, 0.3);
    outline-offset: 2px;
}

/* Print styles */
@media print {
    .header-actions,
    .form-footer {
        display: none;
    }
    
    .form-container,
    .prp-sync-section {
        box-shadow: none;
        border: 1px solid #000;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="create-container">
    <div class="container-fluid">
        
        <!-- Page Header -->
        <div class="page-header">
            <div class="header-content">
                <div class="page-title-section">
                    <h1>
                        <i class="bi bi-person-plus"></i>
                        Create New User
                    </h1>
                    <p>Add user to PIMS - Bangladesh Parliament Secretariat, Dhaka</p>
                </div>
                <div class="header-actions">
                    <a href="{% url 'users:list' %}" class="btn-modern btn-secondary">
                        <i class="bi bi-arrow-left"></i>
                        Back to Users
                    </a>
                </div>
            </div>
        </div>

        <!-- Messages -->
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {% if message.tags == 'error' %}
                        <i class="bi bi-exclamation-triangle-fill"></i>
                    {% elif message.tags == 'success' %}
                        <i class="bi bi-check-circle-fill"></i>
                    {% elif message.tags == 'warning' %}
                        <i class="bi bi-exclamation-circle-fill"></i>
                    {% else %}
                        <i class="bi bi-info-circle-fill"></i>
                    {% endif %}
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        <!-- PRP Sync Options Section -->
        <div class="prp-sync-section">
            <div class="prp-sync-header">
                <h3 class="prp-sync-title">
                    <i class="bi bi-cloud-download"></i>
                    PRP Integration Options
                </h3>
                <div class="sync-status synced">
                    <i class="bi bi-check-circle"></i>
                    PRP Connected
                </div>
            </div>

            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                <div>
                    <strong>Business Rule:</strong> All users must originate from PRP (Parliament Resource Portal). 
                    Manual user creation is only available for administrative purposes and testing.
                    <br><small class="text-muted">Location: Bangladesh Parliament Secretariat, Dhaka</small>
                </div>
            </div>

            <div class="prp-sync-options">
                <!-- Sync from PRP Option -->
                <div class="prp-option-card sync-from-prp active" onclick="togglePRPOption('sync')">
                    <div class="prp-option-header">
                        <div class="prp-option-icon">
                            <i class="bi bi-cloud-download"></i>
                        </div>
                        <div>
                            <h4 class="prp-option-title">Sync from PRP</h4>
                            <p class="prp-option-description">Import user data directly from Parliament Resource Planning</p>
                        </div>
                    </div>
                    <div class="prp-badge">
                        <i class="bi bi-shield-check"></i>
                        Recommended
                    </div>
                </div>

                <!-- Manual Create Option -->
                <div class="prp-option-card manual-create" onclick="togglePRPOption('manual')">
                    <div class="prp-option-header">
                        <div class="prp-option-icon">
                            <i class="bi bi-person-plus"></i>
                        </div>
                        <div>
                            <h4 class="prp-option-title">Manual Creation</h4>
                            <p class="prp-option-description">Create user manually (for testing and administrative purposes only)</p>
                        </div>
                    </div>
                    <div class="sync-status pending">
                        <i class="bi bi-exclamation-triangle"></i>
                        Admin Only
                    </div>
                </div>
            </div>

            <!-- PRP Employee Lookup Section -->
            <div class="prp-lookup-section active" id="prp-lookup">
                <h4 class="lookup-title">
                    <i class="bi bi-search"></i>
                    Search PRP Employee
                </h4>
                <div class="lookup-form">
                    <div class="lookup-group">
                        <label class="lookup-label" for="employee-id-lookup">Employee ID</label>
                        <input type="text" id="employee-id-lookup" class="lookup-input" 
                               placeholder="Enter PRP Employee ID" maxlength="20">
                    </div>
                    <div class="lookup-group">
                        <label class="lookup-label" for="department-select">Department (Optional)</label>
                        <select id="department-select" class="lookup-input">
                            <option value="">Select Department</option>
                            <option value="1">Administration</option>
                            <option value="2">IT Department</option>
                            <option value="3">Finance</option>
                            <option value="4">Human Resources</option>
                            <option value="5">Security</option>
                        </select>
                    </div>
                    <div class="lookup-actions">
                        <button type="button" class="btn-prp btn-sync" onclick="lookupPRPEmployee()">
                            <i class="bi bi-search"></i>
                            Lookup Employee
                        </button>
                        <button type="button" class="btn-prp btn-outline-teal" onclick="clearPRPLookup()">
                            <i class="bi bi-x-circle"></i>
                            Clear
                        </button>
                    </div>
                </div>

                <!-- PRP User Preview (Hidden by default) -->
                <div class="prp-user-preview" id="prp-preview">
                    <div class="preview-header">
                        <div class="preview-avatar">
                            <i class="bi bi-person"></i>
                        </div>
                        <div class="preview-info">
                            <h4 id="preview-name">John Doe</h4>
                            <p id="preview-designation">Senior Software Engineer</p>
                            <div class="prp-badge">
                                <i class="bi bi-cloud"></i>
                                PRP Data
                            </div>
                        </div>
                    </div>

                    <div class="preview-details">
                        <div class="preview-field">
                            <span class="preview-label">Employee ID</span>
                            <span class="preview-value" id="preview-employee-id">EMP001</span>
                        </div>
                        <div class="preview-field">
                            <span class="preview-label">Email</span>
                            <span class="preview-value" id="preview-email">john.doe@parliament.gov.bd</span>
                        </div>
                        <div class="preview-field">
                            <span class="preview-label">Department</span>
                            <span class="preview-value" id="preview-department">IT Department</span>
                        </div>
                        <div class="preview-field">
                            <span class="preview-label">Mobile</span>
                            <span class="preview-value" id="preview-mobile">+880 1712-345678</span>
                        </div>
                        <div class="preview-field">
                            <span class="preview-label">Status</span>
                            <span class="preview-value">
                                <span class="sync-status synced" id="preview-status">
                                    <i class="bi bi-check-circle"></i>
                                    Active
                                </span>
                            </span>
                        </div>
                    </div>

                    <div class="preview-actions" style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: center;">
                        <button type="button" class="btn-prp btn-sync" onclick="importPRPUser()">
                            <i class="bi bi-download"></i>
                            Import This User
                        </button>
                        <button type="button" class="btn-prp btn-outline-teal" onclick="searchAnotherEmployee()">
                            <i class="bi bi-search"></i>
                            Search Another
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manual User Creation Form -->
        <div class="form-container" id="manual-form">
            <div class="form-header">
                <h2 class="form-title">
                    <i class="bi bi-person-plus"></i>
                    User Information Form
                </h2>
                <div class="sync-status pending">
                    <i class="bi bi-person"></i>
                    Manual Entry
                </div>
            </div>

            <div class="form-body">
                <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate id="user-form">
                    {% csrf_token %}

                    <!-- Authentication Section -->
                    <div class="form-section">
                        <h3 class="form-section-title">
                            <i class="bi bi-shield-lock"></i>
                            Authentication Information
                        </h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="{{ form.username.id_for_label }}" class="form-label required">
                                    <i class="bi bi-person-circle"></i>Username
                                </label>
                                {{ form.username }}
                                {% if form.username.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.username.errors %}
                                            <small class="text-danger">{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="bi bi-info-circle"></i>
                                    Username for login. Must be unique.
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="{{ form.employee_id.id_for_label }}" class="form-label required">
                                    <i class="bi bi-badge-4k"></i>Employee ID
                                </label>
                                {{ form.employee_id }}
                                {% if form.employee_id.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.employee_id.errors %}
                                            <small class="text-danger">{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="bi bi-info-circle"></i>
                                    Unique employee identifier from PRP or internal system.
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="{{ form.password1.id_for_label }}" class="form-label required">
                                    <i class="bi bi-key"></i>Password
                                </label>
                                {{ form.password1 }}
                                {% if form.password1.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.password1.errors %}
                                            <small class="text-danger">{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="bi bi-info-circle"></i>
                                    Default password for PRP users: "12345678"
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="{{ form.password2.id_for_label }}" class="form-label required">
                                    <i class="bi bi-key-fill"></i>Confirm Password
                                </label>
                                {{ form.password2 }}
                                {% if form.password2.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.password2.errors %}
                                            <small class="text-danger">{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="bi bi-check-circle"></i>
                                    Re-enter password to confirm
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Personal Information Section -->
                    <div class="form-section">
                        <h3 class="form-section-title">
                            <i class="bi bi-person"></i>
                            Personal Information
                        </h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="{{ form.first_name.id_for_label }}" class="form-label required">
                                    <i class="bi bi-person"></i>First Name
                                </label>
                                {{ form.first_name }}
                                {% if form.first_name.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.first_name.errors %}
                                            <small class="text-danger">{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="form-group">
                                <label for="{{ form.last_name.id_for_label }}" class="form-label required">
                                    <i class="bi bi-person"></i>Last Name
                                </label>
                                {{ form.last_name }}
                                {% if form.last_name.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.last_name.errors %}
                                            <small class="text-danger">{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="{{ form.email.id_for_label }}" class="form-label required">
                                    <i class="bi bi-envelope"></i>Email Address
                                </label>
                                {{ form.email }}
                                {% if form.email.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.email.errors %}
                                            <small class="text-danger">{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="bi bi-info-circle"></i>
                                    Official parliament email address preferred
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="{{ form.phone_number.id_for_label }}" class="form-label">
                                    <i class="bi bi-telephone"></i>Phone Number
                                </label>
                                {{ form.phone_number }}
                                {% if form.phone_number.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.phone_number.errors %}
                                            <small class="text-danger">{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="bi bi-info-circle"></i>
                                    Bangladesh mobile format: +880 1XXX-XXXXXX
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Professional Information Section -->
                    <div class="form-section">
                        <h3 class="form-section-title">
                            <i class="bi bi-briefcase"></i>
                            Professional Information
                        </h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="{{ form.designation.id_for_label }}" class="form-label required">
                                    <i class="bi bi-award"></i>Designation
                                </label>
                                {{ form.designation }}
                                {% if form.designation.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.designation.errors %}
                                            <small class="text-danger">{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="bi bi-info-circle"></i>
                                    Official job title as per PRP records
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="{{ form.office.id_for_label }}" class="form-label required">
                                    <i class="bi bi-building"></i>Office/Department
                                </label>
                                {{ form.office }}
                                {% if form.office.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.office.errors %}
                                            <small class="text-danger">{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="bi bi-info-circle"></i>
                                    Department or office within Parliament Secretariat
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Image Section -->
                    <div class="form-section">
                        <h3 class="form-section-title">
                            <i class="bi bi-image"></i>
                            Profile Information
                        </h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="{{ form.profile_image.id_for_label }}" class="form-label">
                                    <i class="bi bi-camera"></i>Profile Image
                                </label>
                                {{ form.profile_image }}
                                {% if form.profile_image.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.profile_image.errors %}
                                            <small class="text-danger">{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="bi bi-info-circle"></i>
                                    Optional. PRP users will have their photo automatically synced.
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Account Status</label>
                                <div class="form-check">
                                    {{ form.is_active }}
                                    <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                        <i class="bi bi-person-check"></i>Active User Account
                                    </label>
                                </div>
                                <div class="form-check">
                                    {{ form.is_active_employee }}
                                    <label class="form-check-label" for="{{ form.is_active_employee.id_for_label }}">
                                        <i class="bi bi-briefcase-fill"></i>Active Employee
                                    </label>
                                </div>
                                <div class="form-text">
                                    <i class="bi bi-info-circle"></i>
                                    PRP users: Status managed automatically from PRP data
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Administrative Notes Section -->
                    <div class="form-section">
                        <h3 class="form-section-title">
                            <i class="bi bi-sticky"></i>
                            Administrative Notes
                        </h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="{{ form.notes.id_for_label }}" class="form-label">
                                    <i class="bi bi-journal-text"></i>Internal Notes
                                </label>
                                {{ form.notes }}
                                {% if form.notes.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.notes.errors %}
                                            <small class="text-danger">{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="bi bi-info-circle"></i>
                                    Internal administrative notes (not visible to user)
                                </div>
                            </div>
                        </div>
                    </div>

                </form>
            </div>

            <!-- Form Footer -->
            <div class="form-footer">
                <div class="form-info">
                    <small class="text-muted">
                        <i class="bi bi-info-circle"></i>
                        All times are in Bangladesh Standard Time (Asia/Dhaka).
                        PRP-managed users cannot be edited directly.
                    </small>
                </div>
                <div class="form-actions">
                    <button type="submit" form="user-form" class="btn-modern btn-primary">
                        <i class="bi bi-person-plus"></i>
                        Create User
                    </button>
                    <a href="{% url 'users:list' %}" class="btn-modern btn-secondary">
                        <i class="bi bi-x-circle"></i>
                        Cancel
                    </a>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const PRP_CONFIG = {
    lookupUrl: '/users/prp/lookup/',
    syncUrl: '/users/prp/sync/trigger/',
    departmentsUrl: '/users/prp/departments/',
    userDetailUrl: '/users/',
    userListUrl: '/users/'
};

document.addEventListener('DOMContentLoaded', function() {
    // Initialize PRP options
    initializePRPOptions();
    
    // Initialize form validation
    initializeFormValidation();
    
    // Initialize PRP lookup functionality
    initializePRPLookup();
    
    // Load PRP departments
    loadPRPDepartments();
    
    // Initialize tooltips
    initializeTooltips();
});

function initializePRPOptions() {
    // Set default to PRP sync mode
    togglePRPOption('sync');
}

function togglePRPOption(option) {
    const syncCard = document.querySelector('.sync-from-prp');
    const manualCard = document.querySelector('.manual-create');
    const prpLookup = document.getElementById('prp-lookup');
    const manualForm = document.getElementById('manual-form');
    
    // Reset all cards
    syncCard.classList.remove('active');
    manualCard.classList.remove('active');
    
    if (option === 'sync') {
        syncCard.classList.add('active');
        prpLookup.style.display = 'block';
        manualForm.style.display = 'none';
        
        // Show info about PRP sync
        showAlert('info', 'PRP Sync Mode: Search and import users directly from Parliament Resource Portal.');
    } else {
        manualCard.classList.add('active');
        prpLookup.style.display = 'none';
        manualForm.style.display = 'block';
        
        // Show warning about manual creation
        showAlert('warning', 'Manual Mode: Only for administrative and testing purposes. All production users should come from PRP.');
    }
}

function lookupPRPEmployee() {
    const employeeId = document.getElementById('employee-id-lookup').value.trim();
    const departmentId = document.getElementById('department-select').value;
    
    if (!employeeId) {
        showAlert('warning', 'Please enter an Employee ID to search.');
        document.getElementById('employee-id-lookup').focus();
        return;
    }
    
    // Validate employee ID format (should be numbers)
    if (!/^\d+$/.test(employeeId)) {
        showAlert('warning', 'Employee ID should contain numbers only.');
        document.getElementById('employee-id-lookup').focus();
        return;
    }
    
    // Show loading state
    const lookupBtn = document.querySelector('.btn-sync');
    const originalHTML = lookupBtn.innerHTML;
    lookupBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Searching PRP Database...';
    lookupBtn.disabled = true;
    
    // Hide any existing preview
    document.getElementById('prp-preview').classList.remove('active');
    
    // Make REAL API call to PRP lookup endpoint
    fetch(`${PRP_CONFIG.lookupUrl}${employeeId}/`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        // Reset button state
        lookupBtn.innerHTML = originalHTML;
        lookupBtn.disabled = false;
        
        console.log('PRP Lookup Response:', data);
        
        if (data.success) {
            if (data.found_in_prp && data.prp_data) {
                // Display PRP user data
                displayPRPUserPreview({
                    userId: data.prp_data.userId,
                    nameEng: data.prp_data.nameEng,
                    email: data.prp_data.email,
                    designationEng: data.prp_data.designation,
                    department: getDepartmentName(data.prp_data.departmentId),
                    mobile: data.prp_data.mobile,
                    status: data.prp_data.status,
                    departmentId: data.prp_data.departmentId
                });
                
                // Check if user already exists in PIMS
                if (data.found_in_pims) {
                    showAlert('info', `Employee found in PRP! This user already exists in PIMS as: ${data.full_name}. Consider syncing instead of creating.`);
                    
                    // Add link to existing user if profile URL is available
                    if (data.profile_url) {
                        const existingUserLink = `<a href="${data.profile_url}" target="_blank" class="btn btn-sm btn-outline-primary mt-2">
                            <i class="bi bi-person-check"></i> View Existing User
                        </a>`;
                        setTimeout(() => {
                            const actionsDiv = document.querySelector('#prp-preview .preview-actions');
                            if (actionsDiv && !actionsDiv.querySelector('.btn-outline-primary')) {
                                actionsDiv.insertAdjacentHTML('beforeend', existingUserLink);
                            }
                        }, 100);
                    }
                } else {
                    showAlert('success', 'Employee found in PRP database! Review details and click Import to create user account.');
                }
            } else if (data.found_in_pims && !data.found_in_prp) {
                showAlert('warning', `Employee ID ${employeeId} exists in PIMS but not found in PRP database. This might be a local user.`);
                
                if (data.profile_url) {
                    showAlert('info', `<a href="${data.profile_url}" target="_blank">View existing local user</a>`);
                }
            } else {
                showAlert('error', `Employee ID ${employeeId} not found in PRP database. Please verify the ID and try again.`);
            }
        } else {
            // Handle API errors
            const errorMsg = data.error || 'Failed to lookup employee in PRP database.';
            
            if (errorMsg.includes('not available')) {
                showAlert('warning', 'PRP integration is currently unavailable. Please contact system administrator.');
            } else if (errorMsg.includes('authentication')) {
                showAlert('error', 'PRP authentication failed. Please contact system administrator.');
            } else {
                showAlert('error', `PRP Lookup Error: ${errorMsg}`);
            }
        }
    })
    .catch(error => {
        console.error('PRP Lookup Network Error:', error);
        
        // Reset button state
        lookupBtn.innerHTML = originalHTML;
        lookupBtn.disabled = false;
        
        // Show appropriate error message
        if (error.message.includes('HTTP 503')) {
            showAlert('error', 'PRP service is currently unavailable. Please try again later.');
        } else if (error.message.includes('HTTP 401')) {
            showAlert('error', 'Authentication failed. Please contact system administrator.');
        } else if (error.message.includes('HTTP 404')) {
            showAlert('error', 'PRP lookup endpoint not found. Please contact system administrator.');
        } else {
            showAlert('error', 'Network error while searching PRP database. Please check your connection and try again.');
        }
    });
}

function displayPRPUserPreview(userData) {
    const preview = document.getElementById('prp-preview');
    
    if (!preview) {
        console.error('PRP preview element not found');
        return;
    }
    
    // Update preview data safely
    updateElementText('preview-name', userData.nameEng || 'Unknown Name');
    updateElementText('preview-designation', userData.designationEng || 'Unknown Designation');
    updateElementText('preview-employee-id', userData.userId || '');
    updateElementText('preview-email', userData.email || 'No email');
    updateElementText('preview-department', userData.department || 'Unknown Department');
    updateElementText('preview-mobile', userData.mobile || 'No mobile');
    
    // Update avatar if photo exists (placeholder for future enhancement)
    const avatarElement = preview.querySelector('.preview-avatar');
    if (avatarElement) {
        avatarElement.innerHTML = '<i class="bi bi-person-circle"></i>';
    }
    
    // Update status with proper styling
    const statusElement = document.getElementById('preview-status');
    if (statusElement) {
        if (userData.status === 'active') {
            statusElement.className = 'sync-status synced';
            statusElement.innerHTML = '<i class="bi bi-check-circle"></i> Active Employee';
        } else {
            statusElement.className = 'sync-status error';
            statusElement.innerHTML = '<i class="bi bi-x-circle"></i> Inactive Employee';
        }
    }
    
    // Show preview with animation
    preview.classList.add('active');
    
    // Scroll to preview if needed
    setTimeout(() => {
        preview.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 300);
}

function updateElementText(elementId, text) {
    const element = document.getElementById(elementId);
    if (element) {
        element.textContent = text;
    }
}

function importPRPUser() {
    const employeeId = document.getElementById('employee-id-lookup').value.trim();
    
    if (!employeeId) {
        showAlert('error', 'Employee ID is required for import.');
        return;
    }
    
    // Show loading state
    const importBtn = document.querySelector('.preview-actions .btn-sync');
    if (!importBtn) {
        showAlert('error', 'Import button not found.');
        return;
    }
    
    const originalHTML = importBtn.innerHTML;
    importBtn.innerHTML = '<i class="bi bi-download"></i> Importing from PRP...';
    importBtn.disabled = true;
    
    // Disable other buttons
    const otherButtons = document.querySelectorAll('.preview-actions button:not(.btn-sync)');
    otherButtons.forEach(btn => btn.disabled = true);
    
    // Make API call to import/sync user from PRP
    fetch(PRP_CONFIG.syncUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            sync_type: 'user',
            employee_id: employeeId,
            force: true
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('PRP Import Response:', data);
        
        if (data.success) {
            showAlert('success', `User successfully imported from PRP! ${data.result.users_created > 0 ? 'New user created.' : 'User updated.'} Redirecting...`);
            
            // Redirect to appropriate page
            setTimeout(() => {
                if (data.user_id) {
                    // Redirect to user detail page
                    window.location.href = `${PRP_CONFIG.userDetailUrl}${data.user_id}/`;
                } else if (data.result && data.result.users_created > 0) {
                    // Redirect to user list
                    window.location.href = PRP_CONFIG.userListUrl;
                } else {
                    // Refresh current page
                    window.location.reload();
                }
            }, 2000);
        } else {
            // Reset button states
            importBtn.innerHTML = originalHTML;
            importBtn.disabled = false;
            otherButtons.forEach(btn => btn.disabled = false);
            
            const errorMsg = data.error || 'Failed to import user from PRP.';
            
            if (errorMsg.includes('already exists')) {
                showAlert('warning', `${errorMsg} Consider updating the existing user instead.`);
            } else {
                showAlert('error', `Import Failed: ${errorMsg}`);
            }
        }
    })
    .catch(error => {
        console.error('PRP Import Network Error:', error);
        
        // Reset button states
        importBtn.innerHTML = originalHTML;
        importBtn.disabled = false;
        otherButtons.forEach(btn => btn.disabled = false);
        
        if (error.message.includes('HTTP 503')) {
            showAlert('error', 'PRP service is currently unavailable. Please try again later.');
        } else if (error.message.includes('HTTP 401')) {
            showAlert('error', 'Authentication failed. Please contact system administrator.');
        } else {
            showAlert('error', 'Network error during PRP import. Please check your connection and try again.');
        }
    });
}

function clearPRPLookup() {
    document.getElementById('employee-id-lookup').value = '';
    document.getElementById('department-select').value = '';
    const preview = document.getElementById('prp-preview');
    if (preview) {
        preview.classList.remove('active');
    }
    
    // Remove any existing user links
    const existingLinks = document.querySelectorAll('.preview-actions .btn-outline-primary');
    existingLinks.forEach(link => link.remove());
    
    showAlert('info', 'Search form cleared. Enter Employee ID to lookup PRP user.');
    
    // Focus on employee ID field
    setTimeout(() => {
        document.getElementById('employee-id-lookup').focus();
    }, 100);
}

function searchAnotherEmployee() {
    clearPRPLookup();
}

function initializeFormValidation() {
    const form = document.getElementById('user-form');
    if (!form) return;
    
    form.addEventListener('submit', function(event) {
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
            showAlert('danger', 'Please correct the errors in the form before submitting.');
        }
        form.classList.add('was-validated');
    });
    
    // Real-time validation for employee ID
    const employeeIdField = form.querySelector('[name="employee_id"]');
    if (employeeIdField) {
        employeeIdField.addEventListener('input', function() {
            if (this.value && !/^\d{3,}$/.test(this.value)) {
                this.setCustomValidity('Employee ID must be numbers only, minimum 3 digits');
            } else {
                this.setCustomValidity('');
            }
        });
    }
    
    // Real-time validation for phone number (Bangladesh format)
    const phoneField = form.querySelector('[name="phone_number"]');
    if (phoneField) {
        phoneField.addEventListener('input', function() {
            const bdPhonePattern = /^(\+880|880)?[1-9]\d{8,10}$/;
            if (this.value && !bdPhonePattern.test(this.value.replace(/[-\s]/g, ''))) {
                this.setCustomValidity('Please enter a valid Bangladesh phone number (e.g., +880 1712-345678)');
            } else {
                this.setCustomValidity('');
            }
        });
    }
}

function initializePRPLookup() {
    // Add keypress enter support for lookup
    const employeeIdInput = document.getElementById('employee-id-lookup');
    if (employeeIdInput) {
        employeeIdInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                lookupPRPEmployee();
            }
        });
        
        // Add input formatting
        employeeIdInput.addEventListener('input', function() {
            // Remove non-numeric characters
            this.value = this.value.replace(/\D/g, '');
        });
    }
}

function loadPRPDepartments() {
    const departmentSelect = document.getElementById('department-select');
    if (!departmentSelect) return;
    
    // Show loading option
    departmentSelect.innerHTML = '<option value="">Loading departments...</option>';
    
    fetch(PRP_CONFIG.departmentsUrl, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        // Reset select options
        departmentSelect.innerHTML = '<option value="">Select Department (Optional)</option>';
        
        if (data.success && data.departments) {
            // Add PRP departments
            data.departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.id;
                option.textContent = dept.nameEng;
                option.title = dept.nameBng || dept.nameEng; // Tooltip with Bangla name
                departmentSelect.appendChild(option);
            });
            
            console.log(`Loaded ${data.departments.length} departments from PRP`);
        } else {
            // Add fallback departments if PRP fails
            addFallbackDepartments(departmentSelect);
        }
    })
    .catch(error => {
        console.error('Failed to load PRP departments:', error);
        // Add fallback departments
        addFallbackDepartments(departmentSelect);
    });
}

function addFallbackDepartments(selectElement) {
    const fallbackDepartments = [
        { id: '1', name: 'Administration' },
        { id: '2', name: 'IT Department' },
        { id: '3', name: 'Finance' },
        { id: '4', name: 'Human Resources' },
        { id: '5', name: 'Security' },
        { id: '6', name: 'Library' },
        { id: '7', name: 'Transport' }
    ];
    
    selectElement.innerHTML = '<option value="">Select Department (Optional)</option>';
    
    fallbackDepartments.forEach(dept => {
        const option = document.createElement('option');
        option.value = dept.id;
        option.textContent = dept.name;
        selectElement.appendChild(option);
    });
}

function getDepartmentName(departmentId) {
    if (!departmentId) return 'Unknown Department';
    
    const departmentSelect = document.getElementById('department-select');
    if (departmentSelect) {
        const option = departmentSelect.querySelector(`option[value="${departmentId}"]`);
        if (option) {
            return option.textContent;
        }
    }
    
    return `Department ${departmentId}`;
}

function showAlert(type, message) {
    // Remove existing alerts
    const existingAlerts = document.querySelectorAll('.dynamic-alert');
    existingAlerts.forEach(alert => alert.remove());
    
    // Create new alert
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'danger' ? 'danger' : type} alert-dismissible fade show dynamic-alert`;
    alertDiv.setAttribute('role', 'alert');
    
    let icon;
    switch(type) {
        case 'success': icon = 'bi-check-circle-fill'; break;
        case 'danger': 
        case 'error': icon = 'bi-exclamation-triangle-fill'; break;
        case 'warning': icon = 'bi-exclamation-circle-fill'; break;
        default: icon = 'bi-info-circle-fill';
    }
    
    alertDiv.innerHTML = `
        <i class="bi ${icon}"></i>
        <span class="alert-message">${message}</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    // Insert alert at the top of the container
    const container = document.querySelector('.create-container .container-fluid') || 
                     document.querySelector('.container-fluid') || 
                     document.body;
    
    if (container.firstElementChild) {
        container.insertBefore(alertDiv, container.firstElementChild);
    } else {
        container.appendChild(alertDiv);
    }
    
    // Auto-dismiss after 8 seconds (longer for error messages)
    const dismissTime = type === 'error' ? 10000 : 8000;
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.classList.remove('show');
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 300);
        }
    }, dismissTime);
    
    // Scroll to alert
    alertDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function getCSRFToken() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        return csrfToken.value;
    }
    
    // Fallback: try to get from meta tag
    const csrfMeta = document.querySelector('meta[name=csrf-token]');
    if (csrfMeta) {
        return csrfMeta.getAttribute('content');
    }
    
    // Last fallback: try from cookie
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') {
            return value;
        }
    }
    
    console.warn('CSRF token not found');
    return '';
}

function checkPRPConnectionStatus() {
    fetch(PRP_CONFIG.departmentsUrl, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        const statusElements = document.querySelectorAll('.prp-connection-status');
        statusElements.forEach(element => {
            if (data.success) {
                element.innerHTML = '<i class="bi bi-check-circle text-success"></i> PRP Connected';
                element.className = 'prp-connection-status text-success';
            } else {
                element.innerHTML = '<i class="bi bi-exclamation-triangle text-warning"></i> PRP Issues';
                element.className = 'prp-connection-status text-warning';
            }
        });
    })
    .catch(() => {
        const statusElements = document.querySelectorAll('.prp-connection-status');
        statusElements.forEach(element => {
            element.innerHTML = '<i class="bi bi-x-circle text-danger"></i> PRP Disconnected';
            element.className = 'prp-connection-status text-danger';
        });
    });
}

function initializeTooltips() {
    // Initialize Bootstrap tooltips if available
    if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }
}

// Handle page visibility for connection status updates
document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        // Check PRP connection status when page becomes visible
        setTimeout(checkPRPConnectionStatus, 1000);
    }
});

// Handle form submission for manual mode
document.addEventListener('submit', function(event) {
    const form = event.target;
    if (form.id === 'user-form') {
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Creating User...';
        }
    }
});

// Debug mode logging
if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
    console.log('PRP Integration JavaScript loaded for Bangladesh Parliament Secretariat, Dhaka');
    console.log('PRP Config:', PRP_CONFIG);
}
</script>
{% endblock %}